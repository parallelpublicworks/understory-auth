{"version":3,"file":"index.modern.js","sources":["../../../node_modules/mozilla-doc-cookies/index.js","../src/drupal-oauth.js","../src/auth-context.js","../src/index.tsx"],"sourcesContent":["/*\\\n|*|\n|*|  :: cookies.js ::\n|*|\n|*|  A complete cookies reader/writer framework with full unicode support.\n|*|\n|*|  Revision #1 - September 4, 2014\n|*|\n|*|  https://developer.mozilla.org/en-US/docs/Web/API/document.cookie\n|*|  https://developer.mozilla.org/User:fusionchess\n|*|\n|*|  This framework is released under the GNU Public License, version 3 or later.\n|*|  http://www.gnu.org/licenses/gpl-3.0-standalone.html\n|*|\n|*|  Syntaxes:\n|*|\n|*|  * docCookies.setItem(name, value[, end[, path[, domain[, secure]]]])\n|*|  * docCookies.getItem(name)\n|*|  * docCookies.removeItem(name[, path[, domain]])\n|*|  * docCookies.hasItem(name)\n|*|  * docCookies.keys()\n|*|\n\\*/\n\nmodule.exports = {\n  getItem: function (sKey) {\n    if (!sKey) { return null; }\n    return decodeURIComponent(document.cookie.replace(new RegExp(\"(?:(?:^|.*;)\\\\s*\" + encodeURIComponent(sKey).replace(/[\\-\\.\\+\\*]/g, \"\\\\$&\") + \"\\\\s*\\\\=\\\\s*([^;]*).*$)|^.*$\"), \"$1\")) || null;\n  },\n  setItem: function (sKey, sValue, vEnd, sPath, sDomain, bSecure) {\n    if (!sKey || /^(?:expires|max\\-age|path|domain|secure)$/i.test(sKey)) { return false; }\n    var sExpires = \"\";\n    if (vEnd) {\n      switch (vEnd.constructor) {\n        case Number:\n          sExpires = vEnd === Infinity ? \"; expires=Fri, 31 Dec 9999 23:59:59 GMT\" : \"; max-age=\" + vEnd;\n          break;\n        case String:\n          sExpires = \"; expires=\" + vEnd;\n          break;\n        case Date:\n          sExpires = \"; expires=\" + vEnd.toUTCString();\n          break;\n      }\n    }\n    document.cookie = encodeURIComponent(sKey) + \"=\" + encodeURIComponent(sValue) + sExpires + (sDomain ? \"; domain=\" + sDomain : \"\") + (sPath ? \"; path=\" + sPath : \"\") + (bSecure ? \"; secure\" : \"\");\n    return true;\n  },\n  removeItem: function (sKey, sPath, sDomain) {\n    if (!this.hasItem(sKey)) { return false; }\n    document.cookie = encodeURIComponent(sKey) + \"=; expires=Thu, 01 Jan 1970 00:00:00 GMT\" + (sDomain ? \"; domain=\" + sDomain : \"\") + (sPath ? \"; path=\" + sPath : \"\");\n    return true;\n  },\n  hasItem: function (sKey) {\n    if (!sKey) { return false; }\n    return (new RegExp(\"(?:^|;\\\\s*)\" + encodeURIComponent(sKey).replace(/[\\-\\.\\+\\*]/g, \"\\\\$&\") + \"\\\\s*\\\\=\")).test(document.cookie);\n  },\n  keys: function () {\n    var aKeys = document.cookie.replace(/((?:^|\\s*;)[^\\=]+)(?=;|$)|^\\s*|\\s*(?:\\=[^;]*)?(?:\\1|$)/g, \"\").split(/\\s*(?:\\=[^;]*)?;\\s*/);\n    for (var nLen = aKeys.length, nIdx = 0; nIdx < nLen; nIdx++) { aKeys[nIdx] = decodeURIComponent(aKeys[nIdx]); }\n    return aKeys;\n  }\n};\n","import docCookies from \"mozilla-doc-cookies\";\n\nfunction checkIfDuplicateModification(body){\n  return body.hasOwnProperty('errors') &&\n    body.errors.length === 1 &&\n    body.errors[0].status === \"422\" &&\n    body.errors[0].hasOwnProperty('detail') &&\n    body.errors[0].detail ===\n    \"Entity is not valid: The content has either been modified by another user, or you have already submitted modifications. As a result, your changes cannot be saved.\";\n}\n\nfunction getPath(defaultEndpoint, endpointEnvVar){\n  let endpoint = defaultEndpoint;\n  if(process.env[endpointEnvVar]){\n    endpoint = process.env[endpointEnvVar];\n  }\n  return endpoint.replace(/\\/$/, \"\").replace(/^\\//, \"\"); // strip beginning and end slash\n}\n\nexport class DrupalOAuth{\n  constructor(args){\n    if(args.baseUrl){\n      this.baseUrl = args.baseUrl;\n    }\n    if(args.clientId){\n      this.clientId = args.clientId;\n    }\n    this.token = typeof window !== `undefined` && docCookies.hasItem('refresh_token') && docCookies.hasItem('access_token') ? {\n      refresh_token: docCookies.getItem('refresh_token'),\n      access_token: docCookies.getItem('access_token'),\n    } : false;\n    this.isLoggedIn = this.isLoggedIn.bind(this);\n\n  }\n\n  getBaseUrl(){\n    if(!process.env.REACT_APP_ENTITYSYNC_BASE_URL && !this.baseUrl){\n      throw new Error(\"Missing base url for Entity Sync. Please set the REACT_APP_ENTITYSYNC_BASE_URL environment variable or pass in `baseUrl` to the DrupalOAuth object as the base url of your backend, like 'https://www.my-backend.com'\")\n    }\n    if(this.baseUrl){\n      return this.baseUrl;\n    }\n    return process.env.REACT_APP_ENTITYSYNC_BASE_URL.replace(/\\/$/, \"\"); // strip end slash\n  }\n\n  getClientId(){\n    if(!process.env.REACT_APP_ENTITYSYNC_CLIENT_ID && !this.clientId){\n      throw new Error(\"Missing client ID for Entity Sync. Please set the REACT_APP_ENTITYSYNC_CLIENT_ID environment variable or pass in `clientId` to the DrupalOAuth object as the OAuth client_id of your app.\")\n    }\n    if(this.clientId){\n      return this.clientId;\n    }\n    return process.env.REACT_APP_ENTITYSYNC_CLIENT_ID;\n  }\n\n  /**\n   *\n   * @param resp\n   * @returns {Promise<object | boolean>} returns a truthy value if this is a valid response\n   */\n  async verifyResponse(resp){\n    // check match for 2XX status for success\n    if(/2../.test(resp.status.toString())){\n      // Our access token works\n      if(resp.status === 204){\n        //No content returned, don't return any json\n        return true;\n      }\n      return await resp.json();\n    }\n    return false;\n  }\n\n  /**\n   * Fetch data from a Drupal back end. Expects to be called in a locally logged in context (i.e we have some kind of\n   * token). It will try to use the refresh token if it fails via 401 the first time. If it still fails after\n   * refreshing, it will return false, signifying that this user should no longer be logged in.\n   *\n   * @param {string} jsonapiEndpoint An endpoint to retrieve resources using the JSONAPI (https://jsonapi.org/). Includes\n   * everything after the host except the leading slash (ex. `'articles?page[offset]=2'`)\n   * @param {string} method An HTTP verb, mainly meant for `'GET'`, `'POST'`, `'PATCH'` and `'DELETE'`\n   * @param {object|null} body The body of the request, for `'POST'` and `'PATCH'`\n   * @param {object} headers\n   *\n   * @returns {Promise<object | Boolean>} A promise which will return a JSON object of content, true if success with no\n   * content, or false if it failed\n   */\n  async drupalFetch(jsonapiEndpoint, method='GET', body=null, headers=null){\n    if(body && !(body instanceof File)){\n      body = JSON.stringify(body)\n    }\n\n    const base = this.getBaseUrl();\n    const jsonapiBase = getPath('jsonapi', 'REACT_APP_ENTITYSYNC_JSONAPI_BASE');\n    const url = `${base}/${jsonapiBase}/${jsonapiEndpoint}`;\n    const init = {\n      method: method,\n      headers: {\n        'Authorization': `Bearer ${this.token.access_token}`,\n        'Content-Type':  'application/vnd.api+json'\n      },\n    };\n    Object.assign(init.headers, headers);\n    if(body){\n      init.body = body\n    }\n    const resp = await fetch(url, init);\n    const validResponse = await this.verifyResponse(resp);\n    if(validResponse){\n      return validResponse;\n    }\n\n    else if(resp.status === 401 || resp.status === 403){\n      // if we get 401 unauthorized (or apparently a 403, since JSONAPI seems to give us this), its probably because our access token is expired.\n      // refresh and try again with a new token\n      const newToken = await this.refresh();\n      if(newToken) {\n        // Our refresh token is still good, we've got a fresh token\n        init.headers = {\n          'Authorization': `Bearer ${newToken.access_token}`,\n          'Content-Type':  'application/vnd.api+json'\n        };\n        Object.assign(init.headers, headers);\n        const secondResp = await fetch(url, init);\n        // check match for 2XX status for success\n        const validResponse = await this.verifyResponse(secondResp);\n        if(validResponse){\n          return validResponse;\n        }\n        else{\n          /*TODO: Try one more time? We expect to be logged in so either\n           something external happened (and we should try again), the expiration on the token is too short,\n           or we made a bad request.*/\n        }\n      }\n    }\n    else if(resp.status === 422){\n      // if we get a duplicate modification error, just ignore it. our API interactions should be designed to avoid them,\n      // and if any actually do happen, they should be truly duplicate, meaning that the failed one can be safely discarded\n      const body = await resp.json();\n      if(checkIfDuplicateModification(body)){\n        return body;\n      }\n\n    }\n\n    // If everything fails, return false\n    return false;\n  }\n\n  /**\n   * Uses the refresh token stored in the cookie to get a new oauth token.\n   * @returns {Promise<object | Boolean>} A token object with `refresh_token` and `access_token`, or false if no\n   * existing refresh token or login failed (meaning this user is not logged in)\n   */\n  async refresh(){\n    let refreshToken = false;\n    if (typeof window !== `undefined`) {\n      refreshToken = docCookies.getItem('refresh_token');\n    } \n    if(typeof refreshToken !== `undefined` && refreshToken){\n      return await this.authPost('refresh_token', refreshToken);\n    }\n\n    return false\n  }\n\n  /**\n   * Checks local state to see if we have a token. Run refresh\n   * @returns {boolean}\n   */\n  isLoggedIn(){\n    return this.token ? true : false;\n  }\n\n  /**\n   * Authenticates against a Drupal oauth backend. Will set or unset cookie with refresh token on success or failure.\n   *\n   * @param grantType Either `'password'` or `'refresh_token'`\n   * @param authValue The value of the refresh token, if using `refresh_token` grant type\n   * @param FormData object, if you are using the password grant, you should turn your form element into a formData object then pass to authPost. This way you can manipulate the formObject outside of the authPost method.\n   * @returns {Promise<object | Boolean>} A token object with `refresh_token` and `access_token`, or false if login\n   * failed\n   */\n  async authPost(grantType, authValue=null, form=null){\n    const base = this.getBaseUrl();\n    const url = base + '/oauth/token';\n    const formData = form ? form : new FormData();\n    if(authValue){\n      formData.append(grantType, authValue);\n    }\n    formData.append('grant_type', grantType);\n    formData.append('client_id', this.getClientId());\n    const init = {\n      method: 'POST',\n      body: formData,\n    };\n    let resp;\n    try {\n      resp = await fetch(url, init);\n    } catch (e) {\n      console.log(e);\n    }\n    if(resp && resp.status === 200){\n      this.token = await resp.json();\n      if (typeof window !== `undefined`) {\n        docCookies.setItem('refresh_token', this.token.refresh_token, Infinity, '/');\n        docCookies.setItem('access_token', this.token.access_token, Infinity, '/');\n      }\n      return this.token;\n    }\n    // else if(resp.status === 500){\n    //   //service unavailable, trying again\n    //   const secondResp = await fetch(url, init);\n    //   if(secondResp.status === 200){\n    //     this.token = await secondResp.json();\n    //     docCookies.setItem('refresh_token', this.token.refresh_token);\n    //     return this.token;\n    //   }\n    // }\n    else{\n      this.removeTokens();\n      return false;\n    }\n  }\n\n  /**\n   *\n   * @param formData\n   * @param grantType\n   * @returns {Promise<{token: Object|Boolean, uid: null}>}\n   */\n  async loginUser(formData, grantType){\n    const initialLoginResponse = await this.authPost(grantType, null, formData);\n    return { token: initialLoginResponse, };\n  }\n\n  async logoutUser(){\n    if (typeof window !== `undefined`) {\n      this.removeTokens();\n      //removes all localstorage for page\n      localStorage.clear();\n      //removes current access tokens/response\n      this.token = false;\n      return !docCookies.hasItem('refresh_token');\n    } else {\n      return true;\n    }\n  }\n\n  removeTokens(){\n    if (typeof window !== `undefined`) {\n      docCookies.removeItem('refresh_token', '/');\n      docCookies.removeItem('access_token', '/');\n    }\n  }\n\n}\n","import React from \"react\";\n\nimport { DrupalOAuth, } from \"./drupal-oauth\";\n\nconst initialState = {};\nexport const AuthContext = React.createContext(initialState);\n\nconst LOGOUT_USER_ACTION_TYPE = \"LOGOUT_USER\";\nfunction logoutUserAction(){\n  return {\n    type: LOGOUT_USER_ACTION_TYPE,\n  }\n}\n\nconst AUTHENTICATE_USER_ACTION_TYPE = \"AUTHENTICATE_USER\";\nfunction authenticateUserAction(){\n  return {\n    type: AUTHENTICATE_USER_ACTION_TYPE,\n  }\n}\nconst reducer = (state, action) => {\n  switch (action.type) {\n    case AUTHENTICATE_USER_ACTION_TYPE:\n      return {\n        ...state,\n        isAuthenticated: true,\n      };\n    case LOGOUT_USER_ACTION_TYPE:\n      return {\n        ...state,\n        isAuthenticated: false,\n      };\n    default:\n      return state;\n  }\n};\n\n/**\n * A listener for the form submit of the login form.\n * @param {[AuthState, React.Dispatch<AuthAction>]} authContext\n * @param ev\n * @returns {Promise<void>}\n */\nexport async function handleLogin(authContext, ev){\n  const [state, dispatch] = authContext;\n  const auth = new DrupalOAuth(state);\n  const formData = new FormData(event.target);\n  const token = await auth.loginUser(formData, 'password');\n  if(token && token.token) {\n    dispatch(authenticateUserAction());\n  }\n  else{\n    //TODO: inform the user that they failed to log in.\n    return false;\n  }\n}\n/**\n * A listener for the form submit of the login form.\n * @param {[AuthState, React.Dispatch<AuthAction>]} authContext\n * @param formData\n * @returns {Promise<void>}\n */\nexport async function submitLogin(authContext, formData){\n  const [state, dispatch] = authContext;\n  const auth = new DrupalOAuth(state);\n  const token = await auth.loginUser(formData, 'authorization_code');\n  if(token && token.token) {\n    dispatch(authenticateUserAction());\n  }\n  else{\n    //TODO: inform the user that they failed to log in.\n    return false;\n  }\n}\n\nexport function handleLogout(authContext){\n  const [state, dispatch] = authContext;\n  const auth = new DrupalOAuth(state);\n  const loggedOut = auth.logoutUser();\n  //updates the state which forces a re render which will force the user off the page\n  if(loggedOut){\n    dispatch(logoutUserAction());\n  }\n  return loggedOut;\n}\n\n/**\n *\n * This function uses the auth service to retrieve authenticated data. It checks if the user is still signed in after\n * the whole affair is over and updates the store if not.\n *\n * This should not be imported directly, as it expects to be in a logged in environment.\n * Let it be passed into your page component by wrapping it with the `UserContext`.\n *\n * @see signInToView\n * @see AuthContextProvider\n *\n * @param authContext Either the dispatch function to the reducer or the whole auth context, as an array with the state as the first element and the dispatch function as the second.\n * @param {string} jsonapi_endpoint An endpoint to retrieve resources using the JSONAPI (https://jsonapi.org/). Includes\n * everything after the host except the leading slash (ex. `'articles?page[offset]=2'`)\n * @param {string} method An HTTP verb, mainly meant for `'GET'`,`'POST'`, `'PATCH'` and `'DELETE'`\n * @param {Object|null} body The body of the request, for `'POST'` and `'PATCH'`\n * @param headers\n *\n * @returns {Promise<object | Boolean>} A promise which will return a JSON object of content or false if it failed\n */\nexport async function fetchAuthenticatedContent(authContext, jsonapi_endpoint, method='GET', body=null, headers=null){\n  let state, dispatch;\n  if(Array.isArray(authContext)){\n    [state, dispatch] = authContext\n  }\n  else{\n    state = {};\n    dispatch = authContext;\n  }\n  const auth = new DrupalOAuth(state);\n  const content = await auth.drupalFetch(jsonapi_endpoint, method, body, headers);\n  if(!content){\n    dispatch(logoutUserAction());\n  }\n  return content;\n}\n\n/**\n * Wrap the context provider so that the consumer receives the functions from the auth service to login and fetch\n * authenticated content. These functions are bound to the store and will dispatch actions to change the\n * `isAuthenticated` state. Also initiates the process of determining if we are logged in on first page load.\n *\n * @param props can pass in clientId and/or baseUrl to this\n * @returns {*} The\n * @constructor\n */\nexport const AuthContextProvider = props => {\n  const auth = new DrupalOAuth(props);\n  const state =  {...initialState, isAuthenticated: auth.isLoggedIn() };\n\n  if(props.clientId){\n    state.clientId = props.clientId;\n  }\n  if(props.baseUrl){\n    state.baseUrl = props.baseUrl;\n  }\n\n  const [authState, dispatch] = React.useReducer(reducer, state);\n  return (\n    <AuthContext.Provider\n      value={ [{\n        ...authState,\n      }, dispatch] }\n    >\n      {props.children}\n    </AuthContext.Provider>\n  );\n};\n\n","import * as AuthContextLib from \"./auth-context\";\n\nexport const AuthContext = AuthContextLib.AuthContext;\nexport const AuthContextProvider = AuthContextLib.AuthContextProvider;\nexport const submitLogin = AuthContextLib.submitLogin;\nexport const handleLogin = AuthContextLib.handleLogin;\nexport const handleLogout = AuthContextLib.handleLogout;\nexport const fetchAuthenticatedContent = AuthContextLib.fetchAuthenticatedContent;\n"],"names":["getItem","sKey","decodeURIComponent","document","cookie","replace","RegExp","encodeURIComponent","setItem","sValue","vEnd","sPath","sDomain","bSecure","test","sExpires","constructor","Number","Infinity","String","Date","toUTCString","removeItem","hasItem","keys","aKeys","split","nLen","length","nIdx","checkIfDuplicateModification","body","hasOwnProperty","errors","status","detail","getPath","defaultEndpoint","endpointEnvVar","endpoint","process","env","DrupalOAuth","args","baseUrl","clientId","token","window","docCookies","refresh_token","access_token","isLoggedIn","bind","getBaseUrl","REACT_APP_ENTITYSYNC_BASE_URL","Error","getClientId","REACT_APP_ENTITYSYNC_CLIENT_ID","verifyResponse","resp","toString","json","drupalFetch","jsonapiEndpoint","method","headers","File","JSON","stringify","base","jsonapiBase","url","init","Object","assign","fetch","validResponse","newToken","refresh","secondResp","refreshToken","authPost","grantType","authValue","form","formData","FormData","append","e","console","log","removeTokens","loginUser","initialLoginResponse","logoutUser","localStorage","clear","initialState","AuthContext","React","createContext","LOGOUT_USER_ACTION_TYPE","logoutUserAction","type","AUTHENTICATE_USER_ACTION_TYPE","authenticateUserAction","reducer","state","action","isAuthenticated","handleLogin","authContext","ev","dispatch","auth","event","target","submitLogin","handleLogout","loggedOut","fetchAuthenticatedContent","jsonapi_endpoint","Array","isArray","content","AuthContextProvider","props","authState","useReducer","children","AuthContextLib"],"mappings":"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"}